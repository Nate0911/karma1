<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Reddit Karma Checker</title>
  <style>
    body { font-family:sans-serif; text-align:center; padding:2rem }
    button { padding:0.75rem 1.5rem; font-size:1rem }
    #output { margin-top:1.5rem; font-size:1.25rem }
  </style>
</head>
<body>
  <h1>ğŸ” Login with Reddit</h1>
  <button id="loginBtn">Allow Access</button>
  <div id="output" style="display:none">
    Your total karma is: <strong id="karmaCount"></strong>
  </div>

  <script>
    // â”€â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const clientId   = 'BBrhOW-ej5qI-PpblSF-1A';
    const redirectTo = 'https://nate0911.github.io/karma1/';
    const STATE_KEY  = 'reddit_oauth_state';
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    // Only create one stateToken and save it before redirect:
    function getState() {
      let s = sessionStorage.getItem(STATE_KEY);
      if (!s) {
        s = Math.random().toString(36).substr(2);
        sessionStorage.setItem(STATE_KEY, s);
      }
      return s;
    }

    document.getElementById('loginBtn').onclick = () => {
      const state = getState();
      const u = new URL('https://www.reddit.com/api/v1/authorize.compact');
      u.searchParams.set('client_id',     clientId);
      u.searchParams.set('response_type', 'token');
      u.searchParams.set('state',         state);
      u.searchParams.set('redirect_uri',  redirectTo);
      u.searchParams.set('duration',      'temporary');
      u.searchParams.set('scope',         'identity read');
      window.location = u;
    };

    window.addEventListener('load', () => {
      if (!location.hash) return;  // no token yet
      const params = new URLSearchParams(location.hash.slice(1));
      const returnedState = params.get('state');
      const expectedState = sessionStorage.getItem(STATE_KEY);

      if (!returnedState || returnedState !== expectedState) {
        return alert('State mismatchâ€”please try again.');
      }

      // Clean up
      sessionStorage.removeItem(STATE_KEY);

      // Grab the token and fetch karma
      const token = params.get('access_token');
      if (token) {
        fetch('https://oauth.reddit.com/api/v1/me', {
          headers: {
            'Authorization': 'bearer ' + token,
            'User-Agent':    'karmaChecker/1.0 by u/YourRedditUsername'
          }
        })
        .then(r => r.json())
        .then(d => {
          document.getElementById('karmaCount').textContent = d.total_karma;
          document.getElementById('output').style.display = 'block';
        })
        .catch(e => alert('Error fetching karma: ' + e));
      }
    });
  </script>
</body>
</html>
